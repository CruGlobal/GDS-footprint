<!-- ORACLE PREFIX -->

<!-- development testing only -->
<!--   <script src='https://api.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.css' rel='stylesheet' />
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script> -->
<!-- production only -->
<script src="/crudocs/mapbox/mapbox-0.38.0/mapbox-gl.js"></script> 
<link href="/crudocs/mapbox/mapbox-0.38.0/mapbox-gl-oracle_custom1.css" rel='stylesheet' />
<script src="/crudocs/turf/4.4.0/turf.min.js"></script> 

  <style>
    #map-container { width: 1200px; height: 600px;}
    #map { position:relative; width:100%; height:100%}
  </style>
<script>
var all_features = [];
</script>


<!-- ORACLE NARATIVE: -->
<script>
all_features.push(
  '{"type": "Feature", "geometry": {"type": "Point", "coordinates": [@2, @3]}, "properties": {"metric": "@4"}}'
  );
</script>


<!-- ORACLE POSTFIX: -->
<div id='map-container'>
  <div id='map'></div>
  <script>
    // Combine the arrays from OBIEE into a single text string
      var text = '{ "type": "FeatureCollection", "features": [' + all_features + ']}'

  // Parse the combined text string and convert it to GeoJSON format
  var obj = JSON.parse(text);

  mapboxgl.accessToken = 'pk.eyJ1IjoiY3J1LWRzYSIsImEiOiJjajQ1bmpqOG8wa2J1MzNtdTJ5emQ5MzliIn0.uSUw09NoUW0-cg3jinddXQ';
  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v10',
    zoom: 1
  });
  
  map.on('load', function() {

    // Add zoom and rotation controls to the map.
    var nav = new mapboxgl.NavigationControl();
    map.addControl(nav, 'top-left');
    map.addControl(new mapboxgl.FullscreenControl(), 'top-left');

    // Adding 3D-buildings on zoom
    map.addLayer({
        'id': '3d-buildings',
        'source': 'composite',
        'source-layer': 'building',
        'filter': ['==', 'extrude', 'true'],
        'type': 'fill-extrusion',
        'minzoom': 15,
        'paint': {
            'fill-extrusion-color': '#aaa',
            'fill-extrusion-height': {
                'type': 'identity',
                'property': 'height'
            },
            'fill-extrusion-base': {
                'type': 'identity',
                'property': 'min_height'
            },
            'fill-extrusion-opacity': .6
        }
    });

    map.addLayer({
      'id': 'oracle-data',
      'type': 'circle',
      /*'source': obiee,*/
      'source': {
        'type': 'geojson',
        'data': obj
      },
      'layout': {
        'visibility': 'visible'
      },
      'paint': {
        // make circles larger as the user zooms from z12 to z22
        'circle-radius': {
            'base': 1.75,
            'stops': [[12, 2], [22, 180]]
        },
        'circle-color': 'rgba(5,105,155,1)'
      }

    });

  });

</script>
</div>